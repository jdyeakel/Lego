\documentclass[twocolumn,preprintnumbers,amsmath,amssymb,superscriptaddress,linenumbers]{revtex4-1}
% Note that the use of elements such as single-column equations
% may affect the guide line number alignment.
% \templatetype{pnasresearcharticle} % Choose template
% {pnasresearcharticle} = Template for a two-column research article
% {pnasmathematics} = Template for a one-column mathematics article
% {pnasinvited} = Template for a PNAS invited submission
%\usepackage{graphicx}
\usepackage{amsmath,amsfonts,amssymb}
% \usepackage{fullpage}
\usepackage{color}
% \usepackage{subcaption}

\usepackage{amsmath,amsfonts,amssymb}
\usepackage[english]{babel}
% \usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{color}
\usepackage{float}
\usepackage{verbatim}
\usepackage{graphicx}
\usepackage{bm}
\usepackage{mathtools}
\usepackage{stmaryrd}
\usepackage{anyfontsize}
\usepackage{changepage}

% \usepackage{natbib}
% \setcitestyle{comma, sort&compress, super}
% \bibliographystyle{apsrev}

\usepackage[comma,sort&compress]{natbib}
\bibpunct{}{}{,}{s}{}{;}
%\usepackage{authblk}
%\usepackage{multicol}

\bibliographystyle{naturemag}


\newcommand{\rr}[1]{{\rm #1}}

\newcommand{\beginsupplement}{%
        \clearpage
        \setcounter{table}{0}
        \renewcommand{\thetable}{S\arabic{table}}%
        \setcounter{figure}{0}
        \renewcommand{\thefigure}{S\arabic{figure}}%
        \setcounter{equation}{0}
        \renewcommand{\theequation}{S\arabic{equation}}
     }




% \usepackage[english]{babel}
% \usepackage[latin1]{inputenc}
% \usepackage[T1]{fontenc}
% \usepackage{color}
% \usepackage{float}
% \usepackage{verbatim}
% \usepackage{graphicx}
% \usepackage{bm}
% \usepackage{mathtools}
% \usepackage{stmaryrd}
% \usepackage{anyfontsize}
% \usepackage{fullpage}
% \usepackage{color}


% \graphicspath{{../Enigma/figures/}}
% \graphicspath{{../Enigma/figures/}}
\definecolor{darkblue}{rgb}{0.06,0.47,0.59}
\definecolor{darkcyan}{rgb}{0.1,0.3,0.4}
\definecolor{darkgreen}{rgb}{0,0.4,0}
\definecolor{darkred}{rgb}{0.6,0,0}
\definecolor{crimson}{rgb}{0.86,0.08,0.24}

\newcommand{\rev}[1]{\textcolor{crimson}{#1}}
% \newcommand{\uttam}[1]{\textcolor{darkred}{#1}}
\newcommand{\jy}[1]{\textcolor{darkblue}{#1}}
\newcommand{\norm}[1]{\lVert#1\rVert}



\begin{document}

% \title{How fitness and abundance relate to heterogeneity of resources}
% \title{Resource heterogeneity predicts life history tradeoffs and extinction risk from the dynamics of consumer energetic state}
% Scaling resource variability with body size predicts life history strategies, extinction risk, and provides insight into the evolution of grazing}
% \title{Scaling the risk landscape in a consumer foraging model provides insight into optimal life history strategies and the evolution of grazing} %extinction risks
\title{Diverse interactions and ecosystem engineering stabilize community assembly} %extinction risks



\author{Justin D. Yeakel} \affiliation{University
  of California, Merced, Merced, CA 95340, USA} \affiliation{Santa Fe Institute, 1399 Hyde Park Road, Santa Fe, NM 87501, USA}

\author{Mathias M. Pires} \affiliation{Universidade Estadual de Campinas, Campinas - SP, Brazil}

\author{Marcus A. M. de Aguiar} \affiliation{Universidade Estadual de Campinas, Campinas - SP, Brazil}

\author{James L. O'Donnell} \affiliation{University of Washington, Seattle, WA 98195, USA}

\author{Paulo R. Guimar\~aes Jr.} \affiliation{Universidade de S\~ao Paulo, S\~ao Paulo, Brazil}

\author{Dominique Gravel} \affiliation{Universit\`e de Sherbrooke, Sherbrooke, QCJ1K0A5, Canada}

\author{Thilo Gross} \affiliation{University of California, Davis, Davis, CA 95616, USA}

\begin{abstract}
  The complexity of an ecological community can be distilled into a network, where diverse interactions connect species in a web of dependencies. Species interact not only with each other but indirectly through environmental effects, however the role of these ecosystem engineers has not yet been considered in models of ecological networks. Here we explore the dynamics of ecosystem assembly, where the colonization and extinction of species within a community depends on the constraints imposed by trophic, service, and engineering dependencies. We show that our assembly model reproduces many key features of ecological systems, such as the role of generalists during assembly, realistic maximum trophic levels, and increased nestedness with higher frequencies of mutualisms. We find that ecosystem engineering has large and nonlinear effects on extinction rates. While small numbers of engineers reduce stability by increasing the primary extinction frequency, larger numbers of engineers increase stability by both reducing the primary extinction frequency and the size of extinction cascades. We emphasize the importance of redundancies in engineered effects and show that such redundancy lowers the barriers to colonization, promoting community diversity. Together, our results suggest that ecological engineers may enhance community diversity while increasing persistence by facilitating colonization and limiting competitive exclusion. 
\end{abstract}

\maketitle


% \vspace{3mm}
% \begin{adjustwidth}{2.5em}{0em}
% \textbf{Significance} Community assembly is constrained by interactions between and among species, many of which can have lasting effects on the environment. We explore the influence of these ecosystem engineers on colonization and extinction dynamics using a network model that includes trophic, mutualistic, and engineering dependencies between species and the abiotic environment. We find that ecosystem engineering can stabilize assembly particularly when multiple engineers have similar effects on the community.\\
% \end{adjustwidth}



%structure is the result of dynamics
To unravel nature's secrets we must simplify its abundant complexities and idiosyncrasies.
% Simplifying the abundant complexities and eccentricities of nature is necessary to unravel its secrets.
The layers of natural history giving rise to an ecological community can be distilled -- among many forms -- into a network, where nodes represent species and links represent interactions between them.
Networks are generally constructed for one type of interaction, such as food webs capturing predation \cite{Paine1966,Dunne2002,Pascual2006} or pollination networks capturing a specific mutualistic interaction \cite{Bascompte2013}, and continues to lead to significant breakthroughs in our understanding of the dynamical consequences of community structure \cite{May1972,Gross2009,Allesina2012}.
% , assembly \cite{Ponisio2017}, and coevolution \cite{Guimaraes2017}. 
\rev{This perspective has also been used to shed light on the generative processes driving the assembly of complex ecological communities \cite{Montoya2003,Bascompte2009}.}

% \rev{Paragraph on the importance of assembly and models of assembly on structure/dynamics.
% The structure evolves from a feedback between different types of interactions between species and their environment, which leads into the next section.}

\rev{To what extent assembly leaves its fingerprint on the structure and function of ecological communities is a source of considerable debate \cite{Hubbell2001,Tilman2004,Fukami2015}.
% , motivating the investigation of species' attributes that may drive assembly dynamics \cite{Kraft2008,ODwyer2009}.
There is strong evidence that functional traits constrain assembly \cite{Kraft2008,ODwyer2009,Fukami2015}, while differences in species' trophic niche \cite{Brown2002,Piechnik2008}, coupled with early establishment of fast/slow energy channels \cite{Fahimipour2014}, appear to significantly impact long-term community dynamics.
% which species can colonize and persist within the community.
% such as trophic breadth \cite{Brown2002} and body size 
% How species' trophic niche constrains the temporal sequence of colonization \cite{Brown2002} has motivated theoretical models of assembly that have pointed to processes resulting in communities \cite{Wilmers2002,Barbier2018}.
There has been growing interest in understanding the combined role of trophic and mutualistic interactions in driving assembly \cite{Barbier2018,Campbell2011}, where the establishment of species from a source pool \cite{Luh1993,Law1996,Campbell2011} and the plasticity of species interactions \cite{Valdovinos2010,RamosJiliberto2012,Valdovinos2016,Ponisio2019} constrain colonization and extinction dynamics.
Despite these advances, there is not yet a well-defined theory for the assembly of communities that incorporates multiple interaction types and both biotic/abiotic components from which functioning ecosystems are composed (cf. Ref. \citenum{Odum1969}).
}

Recent interest in `multilayer networks' comprising multiple interaction types (multitype interactions) may provide additional insight into these processes \cite{Kefi2016,Pilosof2017}. 
However, interactions where species affect others by altering the abiotic environment in a lasting way have not yet been incorporated into models of ecological networks. 
These interactions, known as ecosystem engineering \cite{Lawton1994,OdlingSmee2013} or more generally niche construction \cite{OdlingSmee2013b,Fukami2015}, are quite common in nature and exist in almost every ecosystem.

% This minimalist perspective provides insight into community structure \cite{Dunne2002,Pascual2006}, and consequently, the dynamics of populations and system stability \cite{May1972,Gross2009,Allesina2012}.
% Community structure can directly impact the ability of the system to absorb external perturbations \cite{Novak2011,Aufderheide2013,Novak2016}, the existence and ubiquity of tipping points marking sudden changes in species' populations \cite{Lade2011,Boettiger2012}, and promote or inhibit extinction cascades \cite{Stouffer2011,Yeakel2014}.
% Importantly, community structure is the result of a dynamical process that takes place over time, where species are added to or removed from the community in succession \cite{Weiher2001}.
% This process is generally referred to as community assembly, and though it is an engine for much that we observe in nature, is not well understood.

%multiple interaction types
% Ecological networks are generally constructed and analyzed with respect to a single type of interaction.
% For example, beneficial relationships between species form the foundation of mutualistic networks, whereas antagonistic interactions form the foundation of trophic networks, or food webs. %- which are often trophic in one direction and a reproductive service in the other -
% There has been a growing interest in understanding community structure by taking into account diverse interaction types \cite{Kefi2016}, where multiple unique interactions are included, sometimes in a multi-layer network \cite{Pilosof2017}.
% Interactions between two species are inherently compound in nature, such that both species in an interaction experiences different effects.
% For example, mutualistic interactions generally involve a flow of biomass in one direction and a reproductive service in the other; in a trophic interaction there is a flow of biomass from the prey to the predator but not the reverse.
% This asymmetry is generally encoded into the dynamics, rather than the network structure itself \cite{Gross2009,Allesina2012}.


%Ecosystem engineering
Diverse interactions occur not only between species but indirectly through the effects that species have on their environment \cite{Jones1994,Olff2009,OdlingSmee2013}.
Elephants root out large saplings and small trees, enabling the formation and maintenance of grasslands \cite{Leuthold1996,Haynes2012} and creating habitat for smaller vertebrates \cite{Pringle2008}.
Burrowing rodents such as gophers and African mole rats create shelter and promote primary production by aerating the soil \cite{Reichman2002,Hagenah2013}, salmon and aquatic invertebrates create freshwater habitats by changing stream morphology \cite{Moore2006}, and leaf-cutter ants alter microclimates, influencing seedling survival and plant growth \cite{Meyer2011}.
These examples illustrate ecosystem engineering, where the engineering organism alters the environment on timescales longer than its own \cite{Hastings2007}.
Engineers are widely acknowledged to have impacts on both small and large spatial scales \cite{Wright2006b}, and likely serve as important keystone species in many habitats \cite{Jones2012}.
% On ecological timescales, ecosystem engineers are relatively common and can alter the landscape on which ecological interactions occur \cite{Wright2006}.

Ecosystem engineering not only impacts communities on ecological timescales, but has profoundly shaped the evolution of life on Earth \cite{Erwin2008}.
For example, the emergence of multicellular cyanobacteria fundamentally altered the atmosphere during the Great Oxidation Event of the Proterozoic roughly 2.5 Byrs BP \cite{Erwin2008,Schirrmeister2013}, paving the way for the biological invasion of terrestrial habitats.
In the oceans it is thought that rRNA and protein biogenesis of aquatic photoautotrophs drove the nitrogen:phosphorous ratio (the Redfield Ratio) to ca. 16:1 matching that of plankton \cite{Loladze2011}, illustrating that engineering clades can have much larger, sometimes global-scale effects.
% While local habitats can be significantly impacted by single engineering species, larger scale effects are generally modified by diverse engineering clades.
% While engineering species such as elephants can have considerable impact on local environments, 
% which illustrates that engineering clades can have much larger, sometimes global-scale effects.


% These example describe indirect interactions between ecosystem engineers and species that rely on their engineering, through an environmental intermediary.
% By way of their indirectness, these interactions are difficult to document.

% GLOBAL SHIFTS ORIGINATE DUE TO ENGINEERING BY A LARGE GROUP OF RELATED SPECIES


% 
% Recent efforts have examined engineering through the lens of niche construction \cite{Krakauer2009}, such as the construction of shared resources such as metabolite in microbiotic communities \cite{Kallus2017}.
% Engineering by way of niche construction is a strategy that may be evolutionary precarious \cite{Krakauer2009}, but may also serve as the missing ingredient that stabilizing some complex ecological systems \cite{Muscarella2017}.

%NOTE: From THILO
% The effect of the abiotic environemt on the lifeforms is commonly included in models because it is felt to be important and can (at least to first approximation) be easily systematized. By compaison the way in which species engineer the environment defies easy systemization due to the multitude of mechanisms by which the engineering occurs. Despite being perhaps of equal importnace engineering is hence omitted from most models.  



The effect of abiotic environmental conditions on species is commonly included in models of ecological dynamics \cite{Woodward2010,Brose2012,Gibert2019b} due to its acknowledged importance and because it can -- to first approximation -- be easily systematized. 
By comparison the way in which species engineer the environment defies easy systemization due to the multitude of mechanisms by which engineering occurs.
% Despite its relevance, the interactions facilitated by ecosystem engineers have not been included in models of ecological networks.
% Interactions between species and the abiotic environment have been conceptually described \cite{Olff2009,Getz2011}, however how these effects impact community function has not been explored.
While interactions between species and the abiotic environment have been conceptually described \cite{Olff2009,Getz2011}, the absence of engineered effects in network models was addressed by Odling-Smee et al. \cite{OdlingSmee2013}, where they outlined a conceptual framework that included both species and abiotic compartments as nodes of a network, with links denoting both biotic and abiotic interactions.
% Importantly, they emphasize the potential eco-evolutionary consequences of prior alterations to the environment influencing an ecological system at some future state.

% Here we model the assembly of ecological communities by the successive arrival of new entities from a source pool into an initially empty system. 
% These entities are modeled as nodes of a network, which include 

%Questions
\rev{How does the assembly dynamics of species constrained by multitype interactions impact community structure and stability?
How are these processes altered when the presence of engineers modifies species' dependencies within the community?}
%HERE WE...
Here we model the assembly of an ecological network where nodes represent ecological entities, including engineering species, non-engineering species, and the effects of the former on the environment, which we call abiotic \emph{modifiers}.
The links of the network that connect both species and modifiers represent trophic (\emph{eat} interactions), service (\emph{need} interactions), and engineering dependencies, respectively (Fig.\ \ref{fig:model}; see Methods for a full description).
\rev{Trophic interactions represent both predation as well as parasitism, whereas service interactions account for non-trophic interactions associated with reproductive facilitation such as pollination or seed dispersal.}
In our framework a traditional mutualism (such as a plant-pollinator interaction) consists of a service (need) interaction in one direction and a trophic (eat) interaction in the other.
These multitype interactions between species and modifiers thus embed multiple dependent ecological sub-systems into a single network (Fig.\ \ref{fig:model}). % with interactions formed by the pairing of two dependency types (eat, need, make;
Modifiers in our framework overlap conceptually with the `abiotic compartments' described in Odling-Smee et al. \cite{OdlingSmee2013}.
Following Pillai et al. \cite{Pillai2011}, we do not track the abundances of biotic or abiotic entities but track only their presence or absence.
We use this framework to explore the dynamics of ecosystem assembly, where the colonization and extinction of species within a community depends on the constraints imposed by the trophic, service, and engineering dependencies.
We then show how observed network structures emerge from the process of assembly, compare their attributes with those of empirical systems, and examine the effects of ecosystem engineers.
% Because ecological assembly is not a memory-less process, it is likely that engineers can have considerable impact on the emergence of community structure and dynamics.
% We use this general framework to study community assembly by invasion of species and their abiotic modifiers, taking into account how interactions between them drive both colonization and extinction.
% Second we integrate the dynamics of invasion of multiple species and abiotic factors with network theory and show how observed network structures depend on historical contingencies.  

Our results offer four key insights into the roles of multitype interactions and ecosystem engineering in driving community assembly.
First, we show that the assembly of communities in the absence of engineering reproduces many features observed in empirical systems.
These include changes in the proportion of generalists over the course of assembly that accord with measured data and trophic diversity similar to empirical observations. % both maximum trophic level and 
Second, we show that increasing the frequency of mutualistic interactions leads to the assembly of ecological networks that are more nested, a common feature of diverse mutualistic systems \cite{Bascompte2003}, but are also prone to extinction cascades.
% We next explore the effects of ecosystem engineering on the dynamics of community assembly.
Our third key result shows that increasing the proportion of ecosystem engineers within a community has nonlinear effects on observed extinction rates.
While we find that a low amount of engineering increases extinction rates, a high amount of engineering has the opposite effect.
% We find that the role of mutualisms on community robustness is linked to the frequency of engineers
% In systems that are highly engineered, the negative effects of mutualisms are reduced
% , and that the inclusion of engineering modifies the effects of service interactions.
Finally we show that redundancies in engineered effects promote community diversity by lowering the barriers to colonization.\\
%and can reduce the negative effects that mutualisms have on species' persistence.
% Only by understanding the effects of engineers on communities can we gain insight into 

% However, we also observe that increased mutualistic dependencies in the assembled communities lower species' persistence.
% This suggests that while nested mutualistic networks appear to be dynamically favored (cf. Ref. \citenum{Rohr2014}), our model predicts that the additional inter-dependencies associated mutualisms should will lead to greater species turnover and changes in community composition.

% 
% %Model description: Pool, colonization, extinction (interaction strength), modifiers
% \noindent \textbf{Assembly of the ENIgMa network}\\
% A combination of two directional interactions between a pair of species defines the ecological relationship linking both.
% % As such, the trophic and mutualistic interactions mentioned above can be deconstructed into two directional interactions.
% A mutualistic interaction between plant x and pollinator y can thus be deconstructed into an `eat' interaction from species x to y and a \emph{need} interaction from species y to x.
% The former represents a directional trophic interaction, or a resource dependency, whereas the latter represents a reproductive service, or a dependency that does not involve biomass flow.
% Another type of mutualism is one defined by non-resource dependencies for both species, often called a service-service mutualism.
% In this case, each species would be connected to the other by directional \emph{need} interactions.
% A trophic interaction between species x and y can be deconstructed by an \emph{eat} interaction from the consumer x to the prey y, but the absence of an interaction from prey y to the consumer x, as the prey does not interact meaningfully with the consumer.
% Some species pairs may participate in bi-directional trophic interactions, where the consumer/resource role changes over the course of each species' life history.
% In this case, each species would be connected to the other by directional \emph{eat} interactions.
% 
% 
% %Interactions with both species and the environment (engineering)
% Ecosystem engineering can be formalized by the creation of a modifier by an engineering species that can be interacted with by other members of a community.
% modifiers made by ecosystem engineers represent any alteration made to the environment, whether this be changes to the stoichiometry of the atmosphere (e.g. primary producers; refs), physical modifications to the landscape (e.g. beavers, salmon; refs), or the production of unique habitats for other organisms (e.g. tree trunks; refs).
% modifiers can be represented in ecological network alongside species as nodes, but where they must be connected to engineering species by a \emph{make} interaction.
% The \emph{make} interaction between an engineering species and the engineered modifier denotes the dependency of the environmental effect on the effector.
% 


%Food webs
\vspace{0mm}
\noindent \textbf{Assembly without ecosystem engineering.}
\noindent Communities assemble by random colonization from a source pool.
A species from the source pool can colonize if it finds at least one resource that it can consume (one \emph{eat} interaction is satisfied; cf. Ref. \citenum{Gravel2011}) and all of its non-trophic needs are met (all \emph{need} interactions are satisfied; see Fig.\ \ref{fig:model}).
% Colonization is possible if a species can fulfill $\geq 1$ trophic requirement (cf. Ref. \citenum{Gravel2011}) and \emph{all} of its service requirements.
As such, service interactions are assumed to be obligate, whereas trophic interactions are flexible -- except in the case of a consumer with only a single resource.
\rev{While a basal resource is always assumed to be present (white node in Fig.\ \ref{fig:model}b)}, following the establishment of an autotrophic base, the arrival of mixotrophs (i.e. mixing auto- and heterotrophy) and lower trophic heterotrophs create opportunities for organisms occupying higher trophic levels to invade.
This expanding niche space initially serves as an accelerator for community growth.
 % comprise the initial colonizers, succeeded by higher trophic consumers.
% Interestingly, we find that community growth is diversity dependent and appears logistic, where the initial colonization phase appears exponential.

Following the initial colonization phase, extinctions begin to slow the rate of community growth.
Primary extinctions occur \rev{if a given species is not the strongest competitor for at least one of its resources}.
% by the competitive exclusion of species sharing similar resources.
\rev{A species' competition strength is determined by its interactions: competition strength is enhanced by the number of need interactions and penalized by the number of its resources (favoring trophic specialists) and consumers (favoring species with fewer predators).}
This encodes three key assumptions: that mutualisms provide a fitness benefit \cite{Bronstein1994}, specialists are stronger competitors than generalists \cite{Macarthur1964,Dykhuizen1980,Futuyma1988,Costa2015}, and many predators entail an energetic cost \cite{Brown1994}.
Secondary extinctions occur when species lose its last trophic or any of its service requirements.
See Fig.\ \ref{fig:model}d,e for an illustration of the assembly process. 
As the colonization and extinction rates converge, the community reaches a steady state around which it oscillates (Fig.\ \ref{fig:trophic}a).
See Methods and Supplementary Appendix 1 for a complete description of the assembly process.
Specific model parameterizations are described in Supplementary Appendix 2. % due to losses from primary extinctions.
% As species richness increases, competitive exclusion initiates the extinction process, followed by secondary extinctions due to the loss of trophic and service requirements among species.


\begin{figure}[h!]
\centering
\includegraphics[width=0.48\textwidth]{fig_model2.pdf}
\vspace{0mm}
\caption{
\textbf{a}, Multitype interactions between species (colored nodes) and abiotic modifiers (black nodes).
Trophic and mutualistic relationships define both species-species (S-S) and species-modifier (S-M) interactions; an engineering interaction is denoted by an engineer that makes a modifier, such that the modifier needs the engineer to persist.
\textbf{b}, An assembling food web with species (color denotes trophic level) and modifiers. The basal resource is the white node at the bottom of the network.
\textbf{c}, The corresponding adjacency matrix with colors denoting interactions between species and modifiers.
\textbf{d}, A species ($\ast$) can colonize a community when a single trophic and all service requirements are met.
\textbf{e}, Greater vulnerability increases the risk of primary extinction via competitive exclusion (competition denoted by dashed line) to species ($\dag$).
The extinction of species ($\dag$) will cascade to affect those connected by trophic ($\dag \dag$) and service ($\dag \dag \dag$) dependencies. 
\vspace{-3mm}
}
\vspace{0mm}
\label{fig:model}
\end{figure}

% 1) connectance
Assembly of ecological communities in the absence of engineering results in interaction networks with structures consistent with empirical observations.
As the community reaches steady state, we find that the connectance of trophic interactions ($C(t)=L(t)/S(t)^2$, where $S(t)$ is species richness and $L(t)$ is the number of links at time $t$) decays to a constant value (Fig.\ \ref{fig:conn}). % similar to that of the source pool over time 
% The species richness of the community increases to $S_{\bm A}=130$.
Decaying connectance followed by stabilization around a constant value has been documented in the assembly of mangrove communities \cite{Piechnik2008} and experimental aquatic mesocosms \cite{Fahimipour2014}. 
The initial decay is likely inevitable in sparse webs as early in the assembly process the small set of tightly interacting species will have a high link density from which it will decline as the number of species increases.
% That the connectance of assembled communities is greater than the source pool is due to the fact that only species connected by trophic interactions can enter the community to begin with, increasing expected link density compared to the overall pool.
Compared to trophic networks constructed using the Niche model \cite{Williams2000} given similar species richness and connectance, our framework results in networks with degree distributions of similar means but with reduced variance (Supplementary Appendix 3).

% 
% \begin{figure}
% \centering
% \includegraphics[width=0.5\textwidth]{fig_specialization.pdf}
% \caption{
% The proportion of specialists as a function of assembly time, where a specialist is defined as a species with a generality index $G_i < 1$.
% All measures of $G_i$ are scaled by the average number of links per species $L/S$, and we consider different values of $L/S$ on $G_i$:
% Circles: $G_i^{\rr{all}}$ where $L$ accounts for all links in the food web and $S$ accounts for all species relative to each time interval in the assembly process (averaged across replicates);
% Points: $G_i^{\rr{hetero}}$, where we consider only the links and species richness of heterotrophs, excluding autotrophs (each point shows an individual replicate);
% Diamonds: $G_i^*$, where $L$ and $S$ are measured with respect to the communities at steady state, which is most similar to the measure used to evaluate assembling mangrove food webs (averaged across replicates).
% }
% \label{fig:spec}
% \end{figure}




%Generality
Recent empirical work has suggested that generalist species may dominate early in assembly, whereas specialists colonize after a diverse resource base has accumulated \cite{Piechnik2008,Gravel2011}.
% Here the trophic generality of species $i$ is defined $G_i = k^{\rm in}_i/(L/S)$ where $k^{\rm in}_i$ is the in-degree, or number of resources consumed, by species $i$ \cite{Williams2000}.
Here the trophic generality of species $i$ is defined as $G_i(t) = k_i^{in}(t)/(L^*/S^*)$ \cite{Williams2000}, where $k_i^{in}(t)$ is the number of species consumed by species $i$ at time $t$, which is scaled by the steady state link density $L^*/S^*$, as is typically done in empirical investigations \cite{Piechnik2008}.
A species is classified as a generalist if $G_i > 1$ and a specialist if $G_i < 1$.
% In empirical investigations, generality is often scaled to the steady state link density $L^*/S^*$.
\rev{If generality is evaluated with respect to the steady state link density, we find that species with many potential trophic interactions realize only a subset of them, thereby functioning as specialists early in the assembly process (Fig.\ \ref{fig:trophic}b).
As the community grows, more potential interactions become realized, and functional specialists become functional generalists.
Moreover, as species assemble the available niche space expands, and the proportion of potential trophic specialists grows (Fig.\ \ref{fig:trophic}b).}
This confirms expectations from the trophic theory of island biogeography \cite{Gravel2011}, where communities with lower richness (i.e. early assembly) are less likely to support specialist consumers than species-rich communities (i.e. late assembly).
% where communities with lower richness (early in assembly) are more likely to support generalist consumers than communities with higher richness (late in assembly). 
At steady state the proportion of functional specialists is ca. 56\%, which is similar to empirical observations of assembling food webs \cite{Piechnik2008}.
%, all measures of $L/S$ are approximately equivalent, and


% If we calculate generality with respect to \emph{realized} trophic interactions, we find that the initial colonizers must be functional specialists, and that the proportion of generalists increase as the community grows (Fig.\ \ref{fig:trophic}b).
% (see Supplementary Appendix, section 4), 
% Perhaps of more interest is that we find a similar trend a species' \emph{potential} trophic interactions are used to calculate generality.
% Here we find that (potential) specialists are more common early in assembly.
% Specialists are assumed to have increased competition strength relative to generalists, and it is the younger communities that experience greater competitive pressures.
% Later in assembly the available niche space grows and competitive exclusion lessens (SUPP FIG?). 
% we observe that generalists dominate early in assembly, with an increase in specialists as assembly progresses (Fig.\ \ref{fig:trophic}B).


%trophic levels
%Trophic Levels & degree dists
\rev{The dominance of functional specialists early in assembly is primarily due to the initial colonization by autotrophs.}
This is evident when we observe that the trophic level (TL) distribution early in assembly ($t=5$) has an average ${\rm TL}=1.6$.
% Additional consumers arrive in the form of both mixotrophs (consuming the basal resource and one or more autotrophs) and heterotrophs, which establish higher trophic levels.
Four trophic levels are typically established by $t=50$, where colonization is still dominant, and by the time communities reach steady state the interaction networks are characterized by an average ${\rm TL_{max}}$ ($\pm$ standard deviation) $=11 \pm 2.8$ (Fig.\ \ref{fig:trophic}c).
While the maximum trophic level is higher than that measured in most consumer-resource systems \cite{Williams2002}, it is not unreasonable if parasitic interactions (which we do not differentiate from other consumers) are included \cite{Lafferty2006}.
Overall, the most common trophic level among species at steady state is ca. ${\rm TL}=4.75$. %, which is similar to average measures  \cite{Williams2002}.

The distribution of trophic levels changes shape over the course of assembly.
Early in assembly, we observe a skewed pyramidal structure, where most species feed from the base of the food web.
At steady state, we observe that intermediate trophic levels dominate, with frequencies taking on an hourglass structure (purple bars, Fig.\ \ref{fig:trophic}c).
Compellingly, the trophic richness pyramids that we observe at steady state follow closely the hourglass distribution observed for empirical food webs and are less top-heavy than those produced by static food web models \cite{Turney2016}.\\




% We emphasize that these structures are diversity-weighted rather than biomass or abundance-weighted as is often the case \cite{Trebilco2013,Gibert2019}.
% Trophic levels higher than 7 do occur, but are rare.

%Cascading extinctions: Thebault
%Assembly patterns: Barbier
%Origin of ecological structure: Stokstad


%Drossel
% [RELATE TO TROPHIC ASSEMBLY MODELS]\\
%Hourglass food webs are predicted for systems where body size increases with trophic position (marine systems)



% 4) Increased mutualisms => greater nestedness
\vspace{0mm}
\noindent \textbf{Structure and dynamics of mutualisms.}
Nested interactions, where specialist interactions are subsets of generalist interactions, are a distinguishing feature of mutualistic networks \cite{Bascompte2003,Bascompte2006,Guimaraes2006,Araujo2010}.
 % and are defined by asymmetric interactions between species \cite{Bascompte2003,Bascompte2006,Guimaraes2006,Araujo2010}.
Nestedness has been shown to maximize the structural stability of mutualistic networks \cite{Rohr2014}, emerge naturally via adaptive foraging behaviors \cite{Valdovinos2016,Valdovinos2019} and neutral processes \cite{Krishna2008}, and promote the influence of indirect effects in driving coevolutionary dynamics \cite{Guimaraes2017}.
While models and experiments of trophic networks suggest that compartmentalization confers greater stabilizing properties \cite{Stouffer2011,Gilarranz2017}, interaction asymmetry among species may promote nestedness in both trophic \cite{Araujo2010} and mutualistic systems \cite{Pires2011}.
Processes that operate on different temporal and spatial scales may have a significant influence on these observations \cite{Massol2011}.
For example, over evolutionary time, coevolution and speciation may degrade nested structures in favor of modularity \cite{Ponisio2019}, and there is some evidence from Pleistocene food webs that geographic insularity may reinforce this process \cite{Yeakel2013}.

\vspace{0mm}
\begin{figure}[h!]
\centering
\includegraphics[width=0.5\textwidth]{fig_trophic3.pdf}
\vspace{0mm}
\caption{
\textbf{a}, Assembling communities over time from a pool of 200 non-engineering species. 
Steady state species richness is reached by $t=250$.
\textbf{b}, The proportion of specialists as a function of assembly time (iterations), where a specialist is defined as a species with a generality index $G_i < 1$.
All measures of $G_i$ are scaled by the average number of links per species where $L$ and $S$ are measured at steady state.
Diamonds denote expected values for functional (realized) trophic interactions at each point in time, and triangles denote expected values for potential trophic interactions (as if all trophic interactions with all species in the pool were realized), where the expectation is taken across replicates. Individual replicate results are shown for functional trophic interactions (small points).
\textbf{c}, The frequency distribution of trophic levels as a function of assembly time (iterations). 
Autotrophs occupy ${\rm TL}=1$.
Measures were evaluated across $10^4$ replicates; see Methods for parameter values.
\vspace{0mm}
}
\label{fig:trophic}
\end{figure}


Does the assembly of ecological networks favor nestedness when mutualistic interactions are frequent?
\rev{In the absence of mutualisms, the trade-offs in our model preclude high levels of nestedness because we assume that generalists are at a competitive disadvantage when they share the same resources with a specialist consumer.
Yet we find that as we increase the frequency of service interactions (holding constant trophic interaction frequency; see Supplementary Appendix 2), the assembled community at steady state becomes more nested (Fig.\ \ref{fig:nest}a).
}
More service interactions increase a species' competition strength, lowering its primary extinction risk.
\rev{Participation in a mutualism thus delivers a fitness advantage to the species receiving the service, compensating for the lower competitive strength of generalists and allowing generalists to share subsets of resources with specialists, which promotes nestedness.}
However increases in mutualisms also increase inter-species dependencies, which raises the potential risk associated with losing mutualistic partners \cite{Bond1994,Colwell2012}. % and its secondary extinction risk
% Indeed, the balance that mutualists must maintain with their partners may have large implications for the future of global biodiversity \cite{Dunn2009}.
\rev{While this shifting landscape of extinction risks lowers the steady state species richness of highly mutualistic communities, we do not observe a direct relationship between nestedness and richness (Fig.\ \ref{fig:nestsize}).}

% 
% Increasing the number of need interactions (Fig.\ \ref{fig:model}) increases the number of both service-resource and service-service dependencies.
% % Increasing service dependencies (\emph{need} interactions; see Fig.\ \ref{fig:model}) promotes both service-resource and service-service dependencies.
% Consider how species with more service interactions compare to those with fewer.
% % As such, elimination of a species that provides a service will result in the secondary extinction of the species that receives that service.
% % While the occurrence of a mutualism assumes a fitness advantage for the species receiving the service, the latter highlights the 
% Indeed, the balance that mutualists must maintain with their partners may have large implications for the future of global biodiversity \cite{Dunn2009}.



% \rev{We find that as we increase the frequency of service interactions (holding constant trophic interaction frequency; see Appendix 2), the assembled community at steady state becomes more nested (Fig.\ \ref{fig:nest}a).}
% That the absolute values of nestedness are low compared to those measured for empirical mutualistic networks is unsurprising: observations of mutualistic interactions are generally for bipartite networks and isolated to specific systems (e.g. ant-plant mutualisms).
% Here the NODF metric is taken across both eat and need interactions across the entire assembled community.
% In this case, nestedness emerges from the assembly process and provides structural stability.
% In this case, nestedness emerges from the assembly process itself.


%MOTIF
% \rev{Increasing the frequency of mutualisms affects extinction dynamics within the community in conflicting ways.
% Consider two motifs composed of trophic and mutualistic interactions, respectively (Fig.\ \ref{fig:nest}, inset).}
% In a trophic motif with no mutualisms, species with high vulnerability (multiple predators) are at greater risk of primary extinction via competitive exclusion. 
% This will result in the secondary extinction of the specialist consumer. 
% If the interactions are instead mutualisms the costs of vulnerability are compensated by services, and it is now the low vulnerability species with fewer trophic partners that is at greater risk of exclusion, preserving the core of the motif at the expense of the periphery.
% Preservation of the core species also emerges in larger nested motifs (Fig.\ \ref{fig:motif}), and has been observed in ant-plant mutualistic systems where nested structures are thought to arise from shifting competitive exclusion to the periphery \cite{Dattilo2013}.
% \rev{The effects of mutualisms will differ across motifs, but they will generally serve to increase competitive advantages of species receiving services, while creating additional structural dependencies within the community.
% }

\rev{When we examine the dynamics of the community as a function of service interaction frequency, we observe that mutualistic interactions have different effects on primary versus secondary extinction rates.
Because service dependencies bolster the competitive strength of otherwise susceptible species such as trophic generalists and species with multiple predators, the rate of primary extinctions is lowered, though this effect is weak (Fig.\ \ref{fig:nest}b).
However, because mutualisms build rigid dependencies between species, more service interactions result in higher frequencies of secondary extinctions (Fig.\ \ref{fig:nest}c). 
In communities with many mutualistic interactions, this combined influence yields extinctions that are less likely to occur, but lead to larger cascades when they do.
}

% 
% Nestedness requires the maintenance of interaction asymmetry between species \cite{Araujo2010}, which in this case emerges from the assembly process.
% Increasing nestedness can be understood by examining the different extinction risks among species within a simple nested motif composed of both trophic and mutualistic interactions (Fig.\ \ref{fig:nest}, inset).
% In the trophic motif, species with high vulnerability (multiple predators) are at greater risk of primary extinction via competitive exclusion.
% This will result in the secondary extinction of the specialist consumer, eliminating the interaction asymmetry. %rendering the nested structure prone to change and 
% In the mutualistic motif and our framework generally, mutualisms are more commonly formed by composite interactions, where the consumer species is engaged in a trophic interaction and the resource species is engaged in a service interaction.
% % As such, the consumer species becomes a trophic partner and the resource species gains the competitive advantages of the service.
% If the competitive advantage of services is greater than the costs of vulnerability (see Methods), it is the low vulnerability species with fewer trophic partners that is at greater risk of exclusion (Fig.\ \ref{fig:nest}, inset).
% \rev{As such, interaction asymmetry is conserved when interactions are mutualistic, and is prone to decay when interactions are purely trophic.
% Preservation of the core species that maintain interaction asymmetry also emerges in larger nested motifs (Fig.\ \ref{fig:motif}), and has been observed in ant-plant mutualistic systems where nested structures are similarly thought to arise from shifting competitive exclusion to the periphery \cite{Dattilo2013}.}
% % As increased nestedness requires conservation of interaction asymmetry, we observe it to emerge in systems with higher frequencies of mutualistic interactions.
% % Because its elimination will not cascade, the nested structure will be more resistant to change.
% 
% \rev{The conservation of interaction asymmetries provided by service interactions in nested motifs should not be construed with stability of the network as a whole. %, and the existence of one does not infer the other
% This is particularly important to note because while nestedness increases with service interaction frequency, the absolute value is low, and this is due to the sparsity of the network.
% When we examine the dynamics of the community as a function of service interaction frequency, we observe that mutualistic interactions have different effects on primary versus secondary extinction rates.
% Because service dependencies bolster the competitive strength of otherwise susceptible species such as trophic generalists and species with multiple predators, the rate of primary extinctions is lowered, though this effect is weak (Fig.\ \ref{fig:nest}b).
% % This serves to lower the rate of primary extinctions (FIG), while simultaneously conserving the asymmetries of nested interactions (Fig.\ \ref{fig:nest}, inset).
% However, because mutualisms build rigid dependencies between species, more services result in higher frequencies of secondary extinctions (Fig.\ \ref{fig:nest}c).
% In communities with many mutualistic interactions, this combined influence yields extinctions that are less likely to occur, but that result in larger cascades when they do.}

% , we observe that these networks have lower species' persistence
 %as well as lower diversity (Supplemental Materials).
% both lower species diversity on average as well as lower species' persistence.
\rev{An increased rate of secondary extinctions means that the network is less robust to perturbation, which may impact community turnover, or persistence.
If we measure persistence in terms of the proportion of time species are established in the community, we find that higher frequencies of service interactions lower average persistence (increased species turnover; Fig.\ \ref{fig:nest}d).
Analysis of species-specific interactions reveals that it is the species that require more services that have lower persistence (Fig.\ \ref{fig:degree}).
% Persistence as measured as the percent simulation time the community is occupied by a given species, averaged across all species that successfully colonize.
% At the community-scale, lower average persistence implies greater species turnover.
Observations of empirical systems appear to support model predictions.
For example, assembling plant-pollinator systems have demonstrated high rates of species and interaction turnover, both during the assembly process and at the steady state \cite{DiazCastelazo2013}.} %\cite{Ponisio2017}
% We also find that increasing a species trophic interactions -- from the perspective of both the prey and predator -- lowers its persistence (Fig.\ \ref{fig:degree}), however communities as a whole are more stable as the trophic link density increases (Fig.\ \ref{fig:meandegree}).
% For an individual species, too many trophic interactions will increase the risk of competitive exclusion (Fig.\ \ref{fig:degree}), however the community as a whole benefits from the structural stability provided by trophic redundancies (Fig.\ \ref{fig:meandegree}).


% Ponisio et al. \cite{Ponisio2017} suggested that the assembly process they observed was ordered by an `opportunistic attachment' rather than `preferential attachment' process, where generalist interactions reordered in response to the changing conditions of the community.
% The framework that we present here employs an attachment dynamic that is more in line with an opportunistic, rather than preferential, process, as invoked by Ponisio et al. \cite{Ponisio2017} to explain observed changes in mutualism structure over the course of assembly.
% Our results suggest that such a process, when employed in randomly assembled multitype interaction networks, results in THE STRUCTURE AND DYNAMICS EXPECTED OF ASSEMBLING MUTUALISTIC SYSTEMS.


\begin{figure}[h!]
\centering
\includegraphics[width=0.5\textwidth]{fig_nested4.pdf}
\vspace{-6mm}
\caption{
\textbf{a}, Structural nestedness of communities, measured as UNODF (Unipartite Nestedness based on Overlap and Decreasing Fill) \cite{Cantor2017}.
The value reported is the mean value taken across the rows and columns of the adjacency matrix accounting for both trophic and service interactions.
% Inset: A trophic and mutualistic nested motif for resource species 1, 2 and consumer species 3, 4.
% Whether the interactions are trophic or mutualistic impacts the susceptibility of each species to primary extinctions (based on differences in competitive strength $\sigma_i$) and secondary extinctions (which result from lost dependencies associated with primary extinctions).
\textbf{b}, Primary extinction rate and \textbf{c}, secondary extinction rate as a function of service interaction frequency.
\textbf{d}, Species persistence as a function of service interaction frequency.
Measures were evaluated for $10^4$ replicates; see Methods and Supplementary Appendix 2 for parameter values.
\vspace{-6mm}
}
\label{fig:nest}
\end{figure}


% An important condition of our model is that we assume that all service interactions are obligate (see Methods), which is expected to heighten the influence of secondary extinctions.
We emphasize that we have restricted ourselves to examining the effects of obligate mutualisms, although the importance of non-obligate mutualisms has long been recognized \cite{RamosJiliberto2012,Vieira2015,Valdovinos2016,Ponisio2017,Valdovinos2019}.
% Because including these
% While the inclusion of non-obligate mutualists will lower the likelihood of cascading effects in systems with higher frequencies of service interactions, the loss of obligate mutualistic partners will have larger dynamic consequences than the loss of more flexible non-obligate mutualistic partners.
\rev{We expect that the increased rate of secondary extinctions attributable to the loss of obligate mutualistic partners to have greater impact on system stability than the potential loss of non-obligate mutualistic partners.}
As such, we do not expect inclusion of non-obligate mutualisms to alter the qualitative nature of our findings.\\
% In future efforts, we aim to explore how the combination of obligate and non-obligate mutualisms impact community dynamics.
% In future efforts, we aim to explore the effects of both obligate and non-obligate mutualistic interactions on community assembly.\\
%What is the CV of mutualistic trajectories?




\vspace{0mm}
\noindent \textbf{Assembly with ecosystem engineering.}
%Theory
The concept of ecosystem engineering, or more generally niche construction, has both encouraged an extended evolutionary synthesis \cite{Laland2015} while also garnering considerable controversy \cite{Gupta2017,Feldman2017}.
Models that explore the effects of ecosystem engineering are relatively few, but have covered important ground \cite{Hastings2007,OdlingSmee2013}.
For example, engineering has been shown to promote invasion \cite{Cuddington2004}, alter primary productivity \cite{Wright2004}, and change the selective environment over eco-evolutionary timescales \cite{Kylafis2008,Krakauer2009} which can lead to unexpected outcomes such as the fixation of deleterious alleles \cite{Laland1999}.
% Initial work focused on understanding how habitat modification might impact the persistence of engineering species \cite{Gurney1996}, while more recent efforts have shown that engineering can promote invasion \cite{Cuddington2004} and impact primary productivity \cite{Wright2004}.
% On eco-evolutionary timescales, ecosystem engineering can alter the selective environment \cite{Krakauer2009,OdlingSmee2013} and ultimately lead to unexpected outcomes such as the fixation of deleterious alleles \cite{Laland1999}.
% On macroevolutionary timescales, there is considerable interest in understanding the role of innovation on diversification and extinction rates within and among clades \cite{Marshall2016}.
% While such innovation generally pertains to the appearance of morphological traits, environmental modifications that result from evolutionary innovations can sometimes be wide-ranging, such as the planetary-scale consequences following the evolution of multicellular cyanobacteria \cite{Schirrmeister2013}.
On smaller scales, microbiota construct shared metabolitic resources that have a significant influence on microbial communities \cite{Kallus2017}, the dynamics of which may even serve as the missing ingredient stabilizing some complex ecological systems \cite{Butler2018}.
\rev{The soil is one place where these macro- and microbiotic systems intersect \cite{Amundson2015}.
Many microbes and detritivores transform and deliver organic matter into the macrobiotic food web, themselves hosting a complex network of trophic and service dependencies between species and abiotic entities \cite{Gutierrez2006,Jouquet2006}.}
%DG: a good case that I completely missed in the first version but that is common, fundamental and relatevely well studied is the soil food web. Microbes and detritivores usually transform the organic matter, changing it's quality and physical state as we move through the processing chain. I've played with such models and a distinct feature they have is the frequence of donor-controlled types of interactions. The transformed organic matter is simply a byproduct of consumption, produced at a rate determined by the provider, not the one benefiting from it. It generates a lot of +,0 interactions that are currently understudied, but also prevalent here in the model. The parallel may further strengthen the paper and also open it to a wider audience. 


We next explore the effects of ecosystem engineering by allowing species to produce abiotic modifiers as additional nodes in the ecological network (Fig.\ \ref{fig:model}).
These modifier nodes produced by engineers can serve to fulfill resource or service requirements for other species.
The parameter $\eta$ defines the mean number of modifiers produced per species in the pool, drawn from a Poisson distribution (see Methods and Supplementary Appendix 1 for details).
If a species makes $\geq 1$ modifier, we label it an engineer.
As the mean number of modifiers/species $\eta$ increases, both the number of engineers in the pool as well as the number of modifiers made per engineer increases.
As detailed in Supplementary Appendix 1, multiple engineers can make the same modifier, such that engineering redundancies are introduced when $\eta$ is large.
When an engineer colonizes the community, so do its modifiers, which other species in the system may interact with.
When engineers are lost, their modifiers will also be lost, though can linger in the community for a period of time inversely proportional to the density of disconnected modifiers (modifiers without a maker) in the community.
% There are two characteristics of engineering that have particular relevance for community assembly: modifiers can linger in the community even after the species that produce them have been excluded, and more than one engineer can produce the same modifier such that engineering redundancies increase with $\eta$.




%Engineering can produce positive feedback dynamics on engineers
%Positive feedback over evolutionary time => speciation/radiation
%Lead to engineering redundancies
%This may be rare as Lawton suggests, but appears to be quite common in the microbial world.
%In microbiomes, horizontal gene transfer can produce redundant engineering without radiations

%Lawton 1994: there may be sometimes redundancy in ecosystem engineers... (uses beaver to suggest that there is not)

%negative (introduces dependencies) then positive (introduces redundancies)
\rev{While the inclusion of engineering does not significantly impact the structure of species-species interactions within assembling food webs (see Supplementary Appendix 4 and Fig.\ \ref{fig:trophiceng}), it does have significant consequences for community stability.
Importantly, these effects also are sensitive to the frequency of service interactions within the community, and we find that their combined influence can be complex.}
% As with food webs without engineering, we measure community stability by assessing
% \emph{i}) rates of primary versus secondary extinctions,
% \emph{ii}) species persistence, and 
% \emph{iii}) steady state community diversity.
% Primary extinctions result from the competitive exclusion of species, whereas secondary extinctions are those that occur as a direct result of the former.
% All measures were averaged over each species within the community across assembly time.

% Increasing engineering has different effects on primary versus secondary extinctions.
As the number of engineers increase, mean rates of primary extinction are first elevated and then decline (Fig.\ \ref{fig:engineers}a).
At the same time, the mean rates of secondary extinction systematically decline and persistence systematically increases (Fig.\ \ref{fig:engineers}b-c).
When engineered modifiers are rare ($0 < \eta \leq 0.5$), higher rates of primary extinction coupled with lower rates of secondary extinction mean that extinctions are common, but of limited magnitude such that disturbances are compartmentalized.
As modifiers become more common both primary and secondary extinction rates decline, which corresponds to increased persistence.
We suggest two mechanisms that may produce the observed results.
First, when engineers and modifiers are present but rare, they provide additional resources for consumers.
This stabilization of consumers ultimately results in increased vulnerability of prey, such that the cumulative effect is increased competitive exclusion of prey and higher rates of primary extinction (Fig.\ \ref{fig:engineers}a).
Second, when engineers and their modifiers are common ($\eta > 0.5$) the available niche space expands, lowering competitive overlap and suppressing both primary and secondary extinctions.
Notably the presence of even a small number of engineers serves to limit the magnitude of secondary extinction cascades.
Assessment of species persistence as a function of trophic in-degree (number of resources) and out-degree (number of consumers) generally supports this proposed dynamic (Fig.\ \ref{fig:indeng}).

% This nonlinear effect of engineering on rates of primary extinction results from two competing forces.
% The first force is observed when engineers and their modifiers are rare ($0 < \eta \leq 0.5$).
% Increased production of abiotic modifiers supplies consumers with additional resources, limiting secondary extinctions and promoting persistence (Fig.\ \ref{fig:engineers}B,~C).


%Mutualisms + Engineering
Increasing the frequency of service interactions promotes service interactions between species and engineered modifiers (Fig.\ \ref{fig:model}).
A topical example of the latter is the habitat provided to invertebrates by the recently discovered rock-boring teredinid shipworm (\emph{Lithoredo abatanica}) \cite{Shipway2019}.
Here, freshwater invertebrates are serviced by the habitat modifications engineered by the shipworm, linking species indirectly via an abiotic effect (in our framework via a modifier node).
As the frequency of service interactions increases, the negative effects associated with rare engineers is diminished (Fig.\ \ref{fig:engineers}a).
Increasing service interactions both elevates the competitive strength of species receiving services (from species and/or modifiers), while creating more interdependencies between and among species.
% Species that serve as resources to many consumers are less competitive due to increased vulnerability.
As trophic interactions are replaced by service interactions, previously vulnerable species gain a competitive foothold and persist, lowering rates of primary extinctions (Fig.\ \ref{fig:engineers}a). %, particularly in systems where consumers are facilitated by a small number of engineers
The costs of these added services to the community are an increased rate of secondary extinctions (Fig.\ \ref{fig:engineers}b) and higher species turnover (Fig.\ \ref{fig:engineers}c), such that extinctions are less common but lead to larger cascades.
% Low rates of primary extinction coupled with high rates of secondary extinction mean that extinctions are less common but lead to larger cascades.
% Importantly, these changes are not due to fluctuations in steady state community richness, which remains relatively constant across the parameter space that we examine (Fig.\ \ref{fig:steadystate}A).

% Together, these results point to an important tradeoff originating from the effects of engineering.
% When engineering and servive interactions are rare, extinction rates are higher, but have smaller consequences; as mutualisms become more common, extinction rates are lower, but have larger consequences.


% Ecosystem engineers can be stabilizing agents in communities if they primarily serve to provide additional resources to non-specialist consumers.
% However if species' presence in the community require the effects induced by engineers, their cumulative influence can be destabilizing.
% Whether engineers are stabilizing or destabilizing is thus largely determined by the flexibility of inter-dependencies connecting species in a community.
% Redundancy in engineered effects both lowers extinction rates while increasing the time that individual species are present within the assembling community.

\vspace{0mm}
\begin{figure}[h!]
\centering
\includegraphics[width=0.5\textwidth]{fig_engineers5.pdf}
\vspace{-8mm}
\caption{
Community stability as a function of the frequency of service interactions and modifiers per species.
\textbf{a}, Mean rates of primary extinction, where primary extinctions occur from competitive exclusion of consumers over shared resources.
\textbf{b}, Mean rates of secondary extinction, which cascade from primary extinctions.
\textbf{c}, Mean species persistence.
\textbf{d}, The ratio $S^*/S^*_{\rm u}$, where $S^*_{\rm u}$ denotes steady states for systems where all engineered modifiers are unique to each engineer, and $S^*$ denote steady states for systems with redundant engineering. Higher values of $S^*/S^*_{\rm u}$ mean that systems with redundant engineers have higher richness at the steady state than those without redundancies.
Primary and secondary extinction rates were evaluated at the community level, whereas persistence was determined for each species and averaged across the community.
Each measure reports the expectation taken across $50$ replicates.
See Methods and Supplementary Appendix 2 for parameter values.
\vspace{0mm}
}
\label{fig:engineers}
\end{figure}



While the importance of engineering timescales has been emphasized previously \cite{Hastings2007}, redundant engineering has been assumed to be unimportant \cite{Lawton1994}.
\rev{We argue that redundancy may be an important component of highly engineered systems, and particularly relevant when the effects of engineers increase their own fitness \cite{Cuddington2004} as is generally assumed to be the case with niche construction \cite{Krakauer2009}.}
% exists a positive feedback between the effects of engineers on their fitness \cite{Cuddington2004}.
The vast majority of contemporary ecosystem engineering case studies focus on single taxa, such that redundant engineers appear rare \cite{Lawton1994}.
However if we consider longer timescales, increasing diversity of engineering clades may promote redundancy, and in some cases this may feed back to accelerate diversification \cite{OdlingSmee2013b}.
Such positive feedback mechanisms likely facilitated the global changes induced by cyanobacteria in the Proterozoic \cite{Erwin2008,Schirrmeister2013} among other large-scale engineering events in the history of life \cite{Erwin2008}.
Engineering redundancies are likely important on shorter timescales as well.
For example, diverse sessile epifauna on shelled gravels in shallow marine environments are facilitated by the engineering of their ancestors, such that the engineered effects of the clade determine the future fitness of descendants \cite{Kidwell1986}.
In the microbiome, redundant engineering may be very common due to the influence of horizontal gene transfer in structuring metabolite production \cite{Polz2013}.
In these systems, redundancy in the production of shared metabolitic resources may play a key role in community structure and dynamics \cite{Kallus2017,Butler2018}.




% %Role of Redundancy
When there are few engineers, each modifier in the community tends to be unique to a particular engineering species.
Engineering redundancies increase linearly with $\eta$ (Supplementary Appendix 1; Fig.\ \ref{fig:redundancy}), such that the loss of an engineer will not necessarily lead to the loss of engineered modifiers. % if alternative engineers persist.
We examine the effects of this redundancy by comparing our results to those produced by the same model, but where each modifier is uniquely produced by a single species.
Surprisingly, the lack of engineering redundancies does not alter the general relationship between engineering and measures of community stability (Fig.\ \ref{fig:unique}).
However we find that redundancies play a central role in maintaining species diversity.
When engineering redundancies are allowed, steady state community richness $S^*$ does not vary considerably with increasing service interactions and engineering (Fig.\ \ref{fig:steadystate}a).
In contrast, when redundant engineering is not allowed, steady state community richness $S^*_u$ declines sharply (Figs. \ref{fig:engineers}d, \ref{fig:steadystate}b).

\rev{Communities lacking redundant engineering have lower species richness because species' trophic and service dependencies are unlikely to be fulfilled given a particular assemblage (Fig.\ \ref{fig:steadystate}c,d).
Colonization occurs only when trophic and service dependencies are fulfilled.}
As such, a species requiring multiple engineered modifiers, each uniquely produced, means that each required entity must precede colonization.
This magnifies the role of priority effects in constraining assembly order \cite{Fukami2015}, precluding many species from colonizing.
\rev{In contrast, redundant engineering increases the temporal stability of species' niches while minimizing priority effects by allowing multiple engineers to fulfill the dependencies of a particular species.}
Our results thus suggest that redundant engineers may play important roles in assembling ecosystems by lowering the barriers to colonization, promoting community diversity.

%Closing
% \rev{We have shown that the dynamics of assembly driven by multitype interactions can produce model communities with realistic structures and dynamics.
% Moreover, the inclusion of ecosystem engineering by way of modifier nodes reveals that low levels of engineering may be expected to produce higher rates of extinction while limiting the size of extinction cascades, and that engineering redundancy -- whether it is common or rare -- may have considerable dynamical implications.}
\rev{We have shown that the dynamics of assembly driven by competitive forces influenced by multitype interactions can produce communities with realistic structures and dynamics. 
Moreover, the inclusion of ecosystem engineering by way of modifier nodes reveals that low levels of engineering may be expected to produce higher rates of extinction while limiting the size of extinction cascades, and that engineering redundancy -- whether it is common or rare -- serves to promote colonization and by extension diversity.}
% Together, these results point to the importance of considering multitype interactions both between species and as mediated through changes to the environment via engineering.
We suggest that including the effects of engineers, either explicitly as we have done here, or otherwise, is vital for understanding the inter-dependencies that define ecological systems.
As past ecosystems have fundamentally altered the landscape on which contemporary communities interact, future ecosystems will be defined by the influence of engineering today.
% \rev{Given the rate and magnitude that humans are currently engineering environments \cite{Corlett2015}, understanding the role of ecosystem engineers is tantamount to understanding our own.}
\rev{Given the rate and magnitude with which humans are currently engineering environments \cite{Corlett2015}, understanding the role of ecosystem engineers is thus tantamount to understanding our own effects on the assembly of natural communities.}\\


% \noindent \textbf{Beyond engineering}
%NOTE: THIS IS DISCUSSION MATERIAL

%EVOLUTION: CITE LOEUILLE, Fussmann, Allhoff 2013,2015; Brannstrom








% \begin{matmethods}
\vspace{-2mm}
\noindent \textbf{Methods}\\
  \footnotesize{
  % \noindent \textbf{The ENIgMa Model}\\
  We model an ecological system with a network where nodes represent \emph{ecological entities} such as populations of species and or the presence of abiotic modifiers affecting species.
   % and links represent interactions between them.
  Following Pilai et al. \cite{Pillai2011}, we do not track the abundances of entities but track only their presence or absence (see also Refs. \citenum{Luh1993,Campbell2011}).
  The links of the network represent interactions between pairs of entities (x,y).
  We distinguish three types of such interactions: x eats y, x needs y to be present, x makes modifier y.

  The assembly process entails two steps: first a source pool of species is created, followed by colonization/extinction into/from a local community.
  The model is initialized by creating $S$ species and $M = \eta S$ modifiers, such that $N=S+M$ is the expected total number of entities (before considering engineering redundancies) and $\eta$ is the expected number of modifiers made per species in the community, where the expectation is taken across replicates.
  For each pair of species (x,y) there is a probability $p_e$ that x eats y and probability $p_n$ that x needs y.
  For each pair of species x and modifier m, there is a probability $q_e$ that species x eats modifier m and a probability $q_n$ that species x needs modifier m.
  Throughout we assume that $p_e = q_e$ and $p_n = q_n$ for simplicity.
  Each species $i$ makes a number of modifiers $M_i \sim \rr{Poiss}(\eta)$ where $\eta$ is the mean number of modifiers made per species.
  If engineering redundancies are allowed, once the number of modifiers per species is determined each modifier is assigned to a species independently to match its assigned number of modifiers.
  This means that multiple species may make the same modifier, and that there may be some modifiers that are not assigned to any species, which are eliminated from the pool.
  Accounting for engineering redundancies, the number of modifiers in the pool becomes $M^\prime = \eta S (\rr{e}-1)/\rr{e}$ where $\rr{e}$ is Euler's number.
  If engineering redundancies are not allowed, each modifier is made by a single engineer and $M^\prime = M$.
  
  In addition to interactions with ecosystem entities, there can be interactions with a basal resource, which is always present.
  The first species always eats this resource, such that there is always a primary producer in the pool.
  Other species eat the basal resource with probability $p_e$.
  Species with zero assigned trophic interactions are assumed to be primary producers.
  See Supplementary Appendix 1 for additional details on defining the source pool.

  We then consider the assembly of a community which at any time will contain a subset of entities in the pool and always the basal resource.
  In time, the entities in the community are updated following a set of rules.
  A species from the pool can colonize the community if the following conditions are met:
  1) all entities that a species needs are present in the community, and
  2) at least one entity that a species eats is present in the community.
  If a colonization event is possible, it occurs stochastically in time with rate $r_\rr{c}$.

  An established species is at risk of extinction if it is not the strongest competitor at least one of its resources that it eats.
  We compute the competitive strength of species $i$ as
  \begin{equation}
    \sigma_i = c_\rr{n} n_i - c_\rr{e} e_i - c_\rr{v} v_i,
  \end{equation}
  where $n_i$ is the number of entities that species $i$ needs, $e_i$ is the number of entities from the pool that species $i$ can eat, and $v_i$ is the number of species in the community that eat species $i$.
  This captures the ecological intuition that mutualisms provide a fitness benefit \cite{Bronstein1994}, specialists are stronger competitors than generalists \cite{Futuyma1988}, and many predators entail an energetic cost \cite{Brown1994}.
  The coefficients $c_\rr{n},~c_\rr{e},~c_\rr{v}$ describe the relative effects of these contributions to competition strength.
  In the following, we use the relationship $c_\rr{n} > c_\rr{e} > c_\rr{v}$, such that the competitive benefit of adding an additional mutualism is greater than the detriment incurred by adding another resource or predator.
  % In the following, we use the values $c_\rr{n} = \pi,~c_\rr{e}=\sqrt{2},~c_\rr{v}=1$, such that the competitive benefit of adding an additional mutualism is greater than the detriment incurred by adding another prey or predator.
  A species at risk of extinction leaves the community stochastically in time at rate $r_e$.

  A modifier is present in the community whenever at least one species that makes the modifier is present.
  If a species that makes a modifier colonizes a community, the modifier is introduced as well, however modifiers may persist for some time after the last species that makes the modifier goes extinct.
  Any modifier that has lost all of its makers disappears stochastically in time at rate $r_m$.

  The model described here can be simulated efficiently with an event-driven simulation utilizing a Gillespie algorithm.
  In these types of simulations, one computes the rates $r_j$ of all possible events $j$ in a given step.
  One then selects the time at which the next event happens by drawing a random number from an exponential distribution with mean $1/\sum_j{r_j}$.
  At this time, an event occurs that is randomly selected from the set of possible events such that the probability of event $a$ is $r_a/\sum_j{r_j}$.
  The effect of the event is then realized and the list of possible events is updated for the next step.
  This algorithm is known to offer a much better approximation to the true stochastic continuous time process than a simulation in discrete time steps, while providing a much higher numerical efficiency \cite{Gillespie1977}.
  Simulations described in the main text have default parameterizations of $S=200$, $p_e=0.01$, $c_{\rm n} = \pi$, $c_{\rm e} = \sqrt{2}$, $c_{\rm v} = 1$, and $4000$ iterations.
  Replicates are defined as the independent assembly of independently drawn source pools with a given parameterization.}

\vspace{2mm}
\noindent \textbf{Data availability}\\
  \footnotesize{
  The study is theoretical; no new empirical data were generated.
  }\\ \\
\noindent \textbf{Code availability}\\
  \footnotesize{
  The simulation code supporting this work is available for download from https://github.com/jdyeakel/Lego.
  }\\

\bibliography{aabib}


\vspace{2mm}
\noindent \textbf{Acknowledgements}\\
  \footnotesize{
  We would like to thank
  Uttam Bhat,
  Irina Birskis Barros,
  Emmet Brickowski,
  Jennifer A. Dunne,
  Ashkaan Fahimipour,
  Marilia P. Gaiarsa,
  Jean Philippe Gibert,
  Christopher P Kempes,
  Eric Libby,
  Lauren C. Ponisio,
  Taran Rallings,
  Samuel V. Scarpino,
  Megha Suswaram,
  Ritwika VPS,
  and two anonymous reviewers
  for insightful discussions and comments throughout the lengthy gestation of this manuscript.
  The original idea was conceived at the Networks on Networks Working Group in G\"ottingen, Germany (2014) and the Santa Fe Institute (2015).
  This work was formerly prepared as a part of the Ecological Network Dynamics Working Group at the National Institute for Mathematical and Biological Synthesis (2015-2019), sponsored by the National Science Foundation through NSF Award DBI-1300426, with additional support from The University of Tennessee, Knoxville.
  Infinite revisions were conducted at the Santa Fe Institute made possible by travel awards to JDY and TG.
  Additional support came from UC Merced startup funds to JDY, the International Centre for Theoretical Physics ICTP-SAIFR, FAPESP (2016/01343-7) and CNPq (302049/2015-0) to MAMA, CNPq and FAPESP (2018/14809-0) to PRG, and DFG research unit 1748 and EPSRC (EP/N034384/1) to TG.
  }\\ \\
  
\noindent \textbf{Author contributions}\\
  \footnotesize{
  JDY and TG conceived of the model framework. JDY, MMP, MAMA, and TG designed the analyses. JDY, MMP, MAMA, JLOD, PRG, DG, and TG analyzed the results and contributed to multiple versions of the manuscript.
  }\\ \\
\noindent \textbf{Competing interests}\\
  \footnotesize{
  The authors declare no competing interests.
  }
\clearpage

\clearpage


\beginsupplement


\section*{Supplementary Methods}
% \subsection*{Appendix A}

% \setcounter{figure}{0}
% \renewcommand{\thefigure}{S\arabic{figure}}
% 
% \setcounter{equation}{0}
% \renewcommand{\theequation}{S\arabic{equation}}

\subsection*{Appendix 1: Building the source pool}
Here and henceforth, we refer to the assembly model presented in the main text as the ENIgMa model (E:eat, N:need, Ig:ignore, Ma:make).
To initiate the ENIgMa assembly model, we must first construct the source pool, where each ecological entity (species + modifiers) is defined by their potential interactions.
The model is initialized by creating $S$ species and $M = \eta S$ modifiers, such that $N=S+M$ is the expected total number of entities (prior to considering engineering redundancies) and $\eta$ is the expected number of modifiers made per species in the community, where the expectation is taken across replicates.
For each pair of species (x,y) there is a probability $p_e$ that x eats y and probability $p_n$ that x needs y.
For each pair of species x and modifier m, there is a probability $q_e$ that species x eats modifier m and a probability $q_n$ that species x needs modifier m.
For simplicity we assume throughout that $p_e$ = $q_e$ and that $p_n = q_n$, such that the probability of drawing trophic and service interactions for both species-species and species-modifier interactions is the same.
% The source pool interaction matrix $\bm P$ is generated by first setting the number of species in the pool $S$ and determining the number of modifiers $M$ that are made by ecosystem engineers.
% The resulting matrix is $N \times N$ where $ N = S + M$, and is subdivided into four quadrants, only two of which play a role here: species-species interactions and species-modifier interactions (see Fig.\ \ref{fig:model}).
% In these two quadrants, the expected frequency of eat interactions ${\rm E}\{p_\rr{e}\}$ and the expected frequency of need interactions ${\rm E}\{p_\rr{n}\}$ are free parameters, as is the expected number of modifiers made per species ${\rm E}\{\mathcal{M}_i\}=\eta$.
% Here and throughout, we simplify this parameter space by assuming that the frequency of eat and need interactions for species-species (SS) interactions and species-modifier (SM) interactions are equivalent, such that ${\rm E_{SS}}\{p_\rr{e}\} = {\rm E_{SM}}\{p_\rr{e}\}$ and ${\rm E_{SS}}\{p_\rr{n}\} = {\rm E_{SM}}\{p_\rr{n}\}$.
% is given by the parameter ${\rm E}\{\mathcal{M}_i\}=\eta$, which determines how many modifiers will be present in the source pool.
% The source pool interaction matrix $\bm P$ is generated by first setting the number of species $\mathcal{S}$ and the expected number of modifiers that are engineered per species ${\rm E}\{\mathcal{M}_i\}=\eta$.

Without engineering redundancies (i.e. each modifier that a species makes is unique), the expected number of modifiers is $M = \eta S$ where $\eta$ is the mean number of modifiers made per species $S$.
If we allow for engineering redundancies, the realized number of modifiers $M^\prime < M$.
To determine the number of modifiers in the pool, for each species a set number of modifiers is drawn, where $M_i \sim {\rm Poiss}(\eta)$.
The expected proportion of species that are engineers (species that make modifiers) is thus $1-{e}^{-\eta}$, where $e$ is Euler's number.
If a particular modifier is randomly and independently drawn for a given engineer from a complete list of all possible modifiers, such that multiple species -- with some probability -- can make the same modifier, the expected number of modifiers becomes
\begin{equation}
M^\prime = \eta S \left(1 - \frac{1}{{e}}\right).
\label{eq:total}
\end{equation}

% This allows multiple species to make the same modifier.
% If each species makes unique modifiers, the number of expected modifiers is $\mathcal{M} = \mathcal{S}\eta$, however because multiple species can make the same modifier, the realized number of modifiers will be lower.
% % To determine whether modifiers are uniquely made or made by multiple engineers, we assign modifiers by randomly drawing independently modifier IDs from $[1:\mathcal{M}_{\rm max}]$ without replacement for each engineer; unassigned modifiers are discarded.
% Each engineer is randomly assigned a modifier, which permits a single modifier to be made by multiple engineers, such that
% \begin{equation}
% {\rm E}\{\mathcal{M}\} = \mathcal{S}\eta\left(1 - \frac{1}{{\rm e}}\right).
% \end{equation}
% where $\rm e$ is Euler's number.
To set interactions between species and modifiers in the pool, we must know the frequency of each directed interaction type.
The frequencies of eat and need interactions, $p_e$ and $p_n$ respectively, are assigned a priori (see Supplementary Appendix 2 for different model parameterizations).
The frequency of engineering (make) interactions can be calculated as
\begin{equation}
p_m = \frac{\eta}{S\left(1 + \eta - \frac{\eta}{e}\right)^2}.
\end{equation}
The frequency of the null interaction is then calculated by $p_\rr{\varnothing} = 1 - (p_e + p_n)$ for species-species interactions and $p_\rr{\varnothing} = 1 - (p_e + p_n+ p_m)$ species-modifier interactions, respectively.
Pairwise interactions are established randomly, such that the source pool matrix has no imbued structure apart from the number of species, the number of modifiers, and the frequency of each directional interaction type.
Each source pool is provided a \emph{basal resource} (the first row/column).
A species with a trophic interaction to this resource is identified as an autotroph (or mixotroph depending on its other trophic interactions).
If they do not have service dependencies with other species/modifiers, it is these species that are uniquely able to initiate assembly.

When engineering redundancies are allowed, the expected number of unique versus redundant modifiers in the source pool can be determined analytically.
The total number of modifiers is $M^\prime = \eta S (1 - \rr{e}^{-1})$, and can be subdivided into modifiers that have a unique engineer and those that have multiple engineers.
The number of modifiers with a single engineer is $M^\prime_{\rr{unique}} = \eta S e^{-1}$.
The number of modifiers made by multiple engineers is calculated as $M^\prime - M^\prime_{\rr{unique}}$, such that
\begin{equation}
M^\prime_{\rr{redundant}} =M^\prime - M^\prime_{\rr{unique}}= \eta S \frac{e - 2}{e},
\label{eq:redundant}
\end{equation}
such that the proportion of redundant modifiers $\phi$ is
\begin{equation}
\phi = \frac{M^\prime - M^\prime_{\rr{unique}}}{M^\prime} = \frac{e-2}{e-1} \approx 0.418.
\label{eq:redundantprop}
\end{equation}
Accordingly, we find that the number of redundant modifiers increases linearly with $\eta$, while the proportion of modifiers that are redundant is fixed.
Figure \ref{fig:redundancy}a,b shows both analytical expectations and numerically-derived measures for $M^\prime_{\rr{redundant}}$ and $\phi$, respectively.

As described in Methods, the assembly process can be simulated efficiently with an event-driven simulation utilizing a Gillespie algorithm.
Generally, one computes the rates $r_j$ of all possible events $j$ in a given step.
One then selects the time at which the next event happens by drawing a random number from an exponential distribution with mean $1/\sum_j{r_j}$.
At this time, an event occurs that is randomly selected from the set of possible events such that the probability of event $a$ is $r_a/\sum_j{r_j}$.
The effect of the event is then realized and the list of possible events is updated for the next step.

In our framework, at the beginning of each simulation step we compute:
1) all species in the pool and absent from the community that have trophic and service dependencies met by those species in the community: these species are subject to colonization;
2) all species in the community that do not have a competition strength that is highest for at least one of their resources: these species are subject to primary extinction;
3) all species in the community that do not meet their eat and/or need dependencies: these species are subject to secondary extinction;
4) all modifiers in the community that no longer have an engineer: these modifiers are subject to elimination.
We then select one of the four events with a probability proportional to the number of entities that satisfy the criteria for each event.
The rates at which each event occurs change at each step, equal to the number of entities that meet the criteria for each event at that point in time.
The species/modifier that colonizes or is eliminated from the community is randomly chosen once the event-type is determined.

For example, if the community is empty, and 50 species are able to colonize, the probability of drawing `colonization' is 1, and the colonizer would be randomly drawn from the 50 capable of colonizing.
Another example: if 20 species are able to colonize, 10 species are not superior competitors for any one of their resources, and 30 species do not meet their dependencies, $\sum_j{r_j} = 60$, and $r_\rr{colonize} = 1/3$, $r_\rr{primary~extinction} = 1/6$, and $r_\rr{secondary~extinction} = 1/2$.
In this case, the most probable event is a secondary extinction.
After this single event takes place, the community is updated depending on which event occurred, and the simulation proceeds to the next step.
This algorithm is known to offer a much better approximation to the true stochastic continuous time process than a simulation in discrete time steps, while providing a much higher numerical efficiency \cite{Gillespie1977}.


\subsection*{Appendix 2: Model parameterizations}
Simulations described in the main text have default parameterizations of $S=200$, $p_e=0.01$, $c_{\rm n} = \pi$, $c_{\rm e} = \sqrt{2}$, $c_{\rm v} = 1$, and $4000$ iterations (time-steps).

\noindent \textbf{Assembly without ecosystem engineering} Here we set the average number of modifiers made per species $\eta = 0$ and the probability of need interactions in the species pool $p_n=0.002$.

\noindent \textbf{Structure and dynamics of mutualisms} Again we used the default parameterizations but set $\eta = 0$, while varying $p_n \in [0,0.002]$.

\noindent \textbf{Assembly with ecosystem engineering} Here we used the default parameterizations but varied $\eta \in [0,2]$ and $p_n \in [0,0.002]$.


\subsection*{Appendix 3: Comparison to Niche Model}
We compared certain structural features of ENIgMa at steady state to those of the Niche Model \cite{Williams2000}.
Comparisons were restricted to networks constructed in the absence of engineering because engineers introduce indirect effects that are not considered in static food web models, and may make such comparisons irrelevant.
While there are many similarities, there are also some important differences, some of which are highlighted in the main text.
While we consider a comparison of our framework with other food web models such as the Niche Model relevant, we emphasize that the motivations underlying both are distinct.
Our approach is intended to provide a deeper understanding into how multitype dependencies between species and the environment impact the dynamics of community assembly.
While capturing general qualitative features of empirical systems demonstrates that the dynamics we consider are ecologically relevant, the goal of our approach is distinct from that of static food web models, which aim to maximize structural similarities between model and empirical systems \cite{Williams2000,Williams2011}.

We compared steady state ecological networks that emerge from ENIgMa (described in Methods, main text) with food webs constructed from the Niche Model \cite{Williams2000} with similar species richness and connectance.
Because species richness and connectance of the Niche Model are often altered by eliminating disconnected species, we compared
\emph{i}) species richness,
\emph{ii}) connectance,
\emph{iii}) mean species degree,
\emph{iv}) standard deviation of out-degree distributions, and
\emph{v}) standard deviation of in-degree distributions
averaged across 1000 replicates for each model.

We found that all measures resulted in fairly similar values between ENIgMa and the Niche Model food webs with a some important differences (Figs. \ref{fig:error1},\ref{fig:error2}).
% Despite these  similarity, there were some consistent differences between them.
While similar, ENIgMa produces consistently lower values of connectance, mean species degree, as well as standard deviations of the in- and out-degree distributions.
This means that the food webs produced by ENIgMa are more sparsely connected with less variance between species.
These results were expected, as the Niche Model assumes systematically increasing dietary ranges with higher niche values, whereas the trophic interactions assigned to species in the source pool of ENIgMa are drawn independently.
An important difference between the Niche Model and ENIgMa is that we do not distinguish between traditional consumers and parasites.
A different framework known as the Inverse Niche Model \cite{Warren2010} has been proposed to address parasitic interactions.
The Inverse Niche Model assumes increasing specialization with feeding hierarchies, which would serve to lower the average generality of species (lower degree).
In addition, the Inverse Niche model outputs lower standard deviations of in- and out-degree distributions.
Together these trends suggest that the qualitative structural differences that we observe for the assembly and Niche model may reflect an important structural distinction between food webs that do and do not include parasitic species.

\subsection*{Appendix 4: The structure of engineered food webs}
We examined whether and to what extent the structure of food webs was altered when engineers are introduced into the community.
Because trophic links can now exist between species-modifiers as well as species-species, there are different ways of accounting for structure, making direct comparisons with non-engineered food webs somewhat difficult.
We note that we exclude service interactions in this case to best match the structural analysis described in the main text and shown in Fig.\ \ref{fig:trophic}.
While the inclusion of engineers ($\eta = 2$) does have an impact on stability in terms of primary versus secondary extinction rates, there is not a strong effect of engineering on steady state species richness (Fig.\ \ref{fig:trophiceng}a; species richness is shown in blue, modifier richness is shown in red).

The role of specialists \emph{does} and \emph{does not} change with the introduction of engineering, depending on how specialization is defined.
As in the main text, a specialist is defined when its generality index $G_i < 1$ relative to the steady state link density.
When engineered modifiers are included, we account for a trophic interaction between a species and another's modifier as an interaction that occurs between those two species indirectly through the modifier intermediary.
So if a species $B$ makes a modifier $M$, and $A$ eats $M$, then we set $A$ to (indirectly) eat $B$.
This accounting of both direct and indirect trophic interactions between species can then be compared to \emph{i}) the direct trophic link density of the community, or \emph{ii}) the direct + indirect trophic link density of the community, and some insights can be gained from both approaches.

In the first case, where $G_i$ is determined relative to $L^*_{\rm direct}/S^*$, we find that there are no potential specialists that colonize the community, and (as in the main text) functional specialists colonize first, but (not as in the main text) become functional generalists at steady state (mean proportion specialists at steady state is 0.04; Fig.\ \ref{fig:trophiceng}b).
This means that the indirect links that define trophic interactions between species and modifiers increase the link-density of the network relative to that defined only by direct trophic interactions.
In words, modifiers serve to connect otherwise disconnected species, formalizing the otherwise indirect relationships that structure the role of engineers in the community.
In the second case, where $G_i$ is determined relative to $L^*_{\rm indirect}/S^*$, we find that the changes in both functional and potential specialists over the course of assembly (Fig.\ \ref{fig:trophiceng}c) follow those observed for non-engineered food webs (Fig.\ \ref{fig:trophic}b).

Finally, we observe that while the number of trophic levels increase in the presence of species-modifier interactions, the overall trophic structure of the community advances over the course of assembly in much the same way as it does without engineers (Fig.\ \ref{fig:trophiceng}d).
Trophic levels are calculated with respect to indirect species interactions through modifier intermediaries.
Because species at any trophic level can engineer modifiers used as resources by other species, the mean trophic level of the community is systematically elevated.

% 
% \textbf{b}, The proportion of specialists as a function of assembly time, where a specialist is defined as a species with a generality index $G_i < 1$ relative to the steady state link density.
% $G_i$ is scaled to the steady state link density where links are direct trophic interactions between species.
% Diamonds represent functional (realized) trophic interactions; triangles represent potential trophic interactions.
% \textbf{c}, The proportion of specialists as a function of assembly time, where a specialist is defined as a species with a generality index $G_i < 1$.
% Here $G_i$ is scaled to the steady state link density where links are composed of \emph{both} direct trophic interactions between species and indirect trophic interactions between consumers and those species that produce modifiers as resources.
% Diamonds represent functional (realized) trophic interactions; triangles represent potential trophic interactions.
% \textbf{d}, The frequency distribution of trophic levels as a function of assembly time (iterations). 
% Autotrophs occupy ${\rm TL}=1$.
% Measures were evaluated across $10^4$ replicates; see Methods for parameter values.

% 
% \subsection*{Appendix 4: Measures of generality}
% 
% The trophic breadth of potential colonizers is thought to play an important role in community assembly.
% The definition of a specialist or generalist to some degree depends on the size and connectance of the larger food web.
% Trophic generality for a species $i$ is defined $G_i = k^{\rm in}_i/(L/S)$, where $k^{\rm in}_i$ is the in-degree, or number of resources consumed by species $i$ \cite{Williams2000}.
% % A species is classified as a generalist if $G_i > 1$ and a specialist if $G_i < 1$.
% A species is classified as a generalist if the number of its trophic interactions is greater than the average number of links per species, or $G_i > 1$, and a specialist if $G_i < 1$, where a community can be described by the proportion of specialists found therein. %$\rho_\rr{s}(G)$
% For interaction networks that are assembling over time, generality can be scaled by a number of different measures of $L/S$, and this has a large effect on our interpretation of the role of generality in community assembly.
% For instance, $L/S$ may be quantified by either including all autotrophic species or only autotrophic functional groups.
% Furthermore, the scaling of generality may be made with respect to the current state of the community at each point in time, or with respect to the community at steady state.
% For instance, in their investigation of assembling mangrove food webs, Piechnik et al. \cite{Piechnik2008} scaled trophic breadth to a standard steady state value of $L^*/S^* = 0.2$ averaged across 102 food webs.
% 
% To examine how our assessment of the role of generalism over the course of assembly changes based on the application of different scalings, we employ three different measures of $L/S$ to calculate $G_i$:
% 1) $G_i^{\rr{all}}$, where $L$ accounts for all links in the food web and $S$ accounts for all species relative to each time interval in the assembly process (circles; Fig.\ \ref{fig:spec}b);
% 2) $G_i^{\rr{hetero}}$, where we consider only the links and species richness of heterotrophs, excluding autotrophs (points; Fig.\ \ref{fig:spec}b);
% 3) $G_i^*$, where $L$ and $S$ are measured with respect to the communities at steady state, which is most similar to the measure used to evaluate assembling mangrove food webs (diamonds; Fig.\ \ref{fig:spec}b).
% Whether trophic breadth is scaled to the current state of $L/S$ or the steady state value of $L^*/S^*$ has a large influence on the estimated proportion of generalists in the community, particularly when the size of the system is small.
% We observe that for $G_i^{\rr{all}}$, the system is initially assembled by specialist species, though over the course of assembly the proportion of specialists relative to generalists declines to intermediate values (circles representing the average over replicates in Fig.\ \ref{fig:spec}).
% If only the trophic links between non-autotrophs are considered as in $G_i^{\rr{hetero}}$, specialists still dominate early in assembly, but there is a greater range, such that some systems can be described by a mixed proportion of specialists and generalists (individual points representing independent replicates in Fig.\ \ref{fig:spec}).
% 
% The different normalizations by which generality is measured will impact the interpretation of both empirical and model systems alike.
% In our framework, species colonizing early in the assembly process are generalists compared to how the term is defined at the steady state, but they are functionally specialists with respect to the assembling community.
% For example, a species that is trophically connected to 10 resource species in the source pool may colonize a community where it is consuming a small subset of its potential range.
% As the community grows, that species may realize more of its trophic niche if those resource species subsequently colonize the system.
% To what end we label this species a generalist or specialist relative to the assembling community is thus subject to multiple interpretations.
% % Because link density is dynamic over the course of assembly, it is not altogether obvious which measure is more appropriate

% 
% \subsection*{Appendix 5: Measures of generality}



\begin{figure*}[h!]
\centering
\includegraphics[width=0.6\textwidth]{fig_conn.pdf}
\caption{
Left: Assembly of communities over time results in steady state species richness by ca. time-step 250.
Right: Trophic connectance early in assembly is high because a small number of species interact with each other such that the proportion of realized interactions (out of all possible interactions) is closer to unity.
Over time, connectance decays as species richness increases, and the density of trophic interactions declines.
}
\label{fig:conn}
\end{figure*}



\begin{figure*}[h!]
\centering
\includegraphics[width=0.8\textwidth]{fig_errorscatter2.pdf}
\caption{
Comparisons of raw structural measures for the assembly (y-axis) and Niche model (x-axis).
If the models produce similar structures, metrics will tend to fall on the 1:1 line (drawn).
While the values for both models are similar, connectance, mean degree, and the standard deviation of in- and out-degree are all lower for the assembly model relative to those measures for the Niche model.
}
\label{fig:error1}
\end{figure*}

\begin{figure*}[h!]
\centering
\includegraphics[width=0.8\textwidth]{fig_error2.pdf}
\caption{
Error between structural measures of the assembly and Niche models.
Error is measured as $\sqrt{(m_i - m_j)^2}$, where $m_i$ and $m_j$ are structural metrics for the assembly and Niche model, respectively.
Only the trophic network of the assembly model was used to assess metrics.
}
\label{fig:error2}
\end{figure*}



% 
% \begin{figure*}[h!]
% \centering
% \includegraphics[width=0.8\textwidth]{fig_specialization.pdf}
% \caption{
% The proportion of specialists as a function of assembly time, where a specialist is defined as a species with a generality index $G_i < 1$.
% Measures of $G_i$ are shown normalized to different measures of link-density.
% Circles: $G_i^{\rr{all}}$ where $L$ accounts for all links in the food web and $S$ accounts for all species relative to each time interval in the assembly process (averaged across replicates).
% Points: $G_i^{\rr{hetero}}$, where we consider only the links and species richness of heterotrophs, excluding autotrophs (each point shows an individual replicate).
% Diamonds: $G_i^*$, where $L$ and $S$ are measured with respect to the communities at steady state (averaged across replicates). 
% This measure is the one presented in the main text and most similar to that used to evaluate assembling mangrove food webs \cite{Piechnik2008}.
% }
% \label{fig:spec}
% \end{figure*}



% \begin{figure*}[h!]
% \centering
% \includegraphics[width=0.8\textwidth]{fig_mutsecext.pdf}
% \caption{
% Mean rates of secondary extinction with increasing service interactions.
% }
% \label{fig:mutsecext}
% \end{figure*}

% 
% \begin{figure*}[h!]
% \centering
% \includegraphics[width=0.6\textwidth]{fig_motif.pdf}
% \caption{
% \textbf{a}, The 4-species nested trophic and mutualistic motif described in the main text.
% \textbf{b}, A 6-species nested trophic and mutualistic motif. For the trophic motif at time-step 1, it is the core species of the motif that are at greatest risk of extinction. For the mutualistic motif at time-step 1 it is the peripheral species at greatest risk.
% \textbf{c}, Nestedness (UNODF) of the 6-species trophic and mutualistic motif over the course of the two time-steps illustrated in \textbf{b}. While nestedness decays in both following the primary and secondary extinctions, it decays more slowly for the mutualistic motif.
% While suggesting that the dynamics of a single (among many possible) motif cannot simply be extended to the entire network, we suggest that the maintenance of asymmetric interactions among species engaged in mutualistic interactions may be important for the observed increase in nestedness when service interactions are frequent.
% }
% \label{fig:motif}
% \end{figure*}


\begin{figure*}[h!]
\centering
\includegraphics[width=0.8\textwidth]{fig_nestedvsize.pdf}
\caption{
Nestedness (UNODF) as a function of steady state richness for 1000 replicated communities without service interactions ($p_n = 0$) compared to those with a high frequency of service interactions ($p_n = 0.002$).
While higher frequencies of service interactions do lower steady state species richness (due to increasing secondary extinction rates), there is not a relationship between nestedness and species richness across replicates for a given service interaction frequency.
}
\label{fig:nestsize}
\end{figure*}




\begin{figure*}[h!]
\centering
\includegraphics[width=0.8\textwidth]{fig_persistdegree_boxall.pdf}
\caption{
Persistence as a function of trophic and service in/out-degree for communities with higher densities of service interactions ($p_e = 0.01;~p_n = 0.002$).
Left column: species-specific persistence as a function of trophic in-degree (the number of prey a species has; top) and out-degree (the number of predators a species has; bottom).
Right column: species-specific persistence as a function of the mutualism in-degree (the number of service receivers a species has; top) and out-degree (the number of service providers a species has; bottom).
As the trophic in- and out-degree of species increases, competition strength is lowered and persistence decreases.
As the mutualism in-degree increases, so does the number of service donors that are needed for the receiving species to remain in the community. This introduces structural constraints that lowers persistence.
}
\label{fig:degree}
\end{figure*}


\begin{figure*}[h!]
\centering
\includegraphics[width=0.7\textwidth]{fig_trophic3_eng.pdf}
\caption{
\textbf{a}, Assembling communities over time from a pool of 200 non-engineering species. 
Steady state species richness is reached by $t=250$.
\textbf{b}, The proportion of specialists as a function of assembly time, where a specialist is defined as a species with a generality index $G_i < 1$ relative to the steady state link density.
$G_i$ is scaled to the steady state link density where links are direct trophic interactions between species.
Diamonds represent functional (realized) trophic interactions; triangles represent potential trophic interactions.
\textbf{c}, The proportion of specialists as a function of assembly time, where a specialist is defined as a species with a generality index $G_i < 1$.
Here $G_i$ is scaled to the steady state link density where links are composed of \emph{both} direct trophic interactions between species and indirect trophic interactions between consumers and those species that produce modifiers as resources.
Diamonds represent functional (realized) trophic interactions; triangles represent potential trophic interactions.
\textbf{d}, The frequency distribution of trophic levels as a function of assembly time (iterations). 
Autotrophs occupy ${\rm TL}=1$.
Measures were evaluated across $10^4$ replicates; see Methods for parameter values.
}
\label{fig:trophiceng}
\end{figure*}


\begin{figure*}[h!]
\centering
\includegraphics[width=0.7\textwidth]{fig_indeng_combined.pdf}
\caption{
Species-specific persistence as a function of \textbf{a} trophic in-degree (number of resources a species has; top) and \textbf{b} out-degree (number of consumers that eat the species; bottom) when there are no engineers in the community. 
Species-specific persistence as a function of \textbf{c} trophic in-degree (number of resources a species has; top) and \textbf{d} out-degree (number of consumers that eat the species; bottom) when engineers are rare ($\eta = 0.5$).
The notion that having a small number of engineers and modifiers in the community increases rates of primary extinction (Fig.\ \ref{fig:engineers}a) by stabilizing consumers at the expense of their prey is supported by \emph{i}) increased persistence of generalist consumers, and \emph{ii}) the presence of species with larger number of predators.
Species-specific persistence as a function of \textbf{e} trophic in-degree (number of resources a species has; top) and \textbf{f} out-degree (number of consumers that eat the species; bottom) when engineers are common ($\eta = 2.0$).
The notion that a large number of engineers and modifiers in the community decrease rates of primary extinction (Fig.\ \ref{fig:engineers}a) due to expanding niche space (diffusing the effects of competitive exclusion) is supported by the lack of correlation between trophic in/out-degree and persistence.
}
\label{fig:indeng}
\end{figure*}



% \begin{figure*}[h!]
% \centering
% \includegraphics[width=0.8\textwidth]{fig_persistdegree2.pdf}
% \caption{
% Top row: Mean persistence as a function of mean trophic degree, where the mean is taken across species, and the degree is the number of \emph{potential} trophic interactions if all species were present in the community. Each point is a replicate and columns correspond to different frequencies of service interactions.
% Middle row: Mean persistence as a function of mean trophic degree, where the mean is taken across species, and the degree is the time-averaged number of \emph{realized} trophic interactions. Each point is a replicate and columns correspond to different frequencies of service interactions.
% Bottom row: Mean persistence as a function of mean mutualism degree, where the mean is taken across species. Each point is a replicate and columns correspond to different frequencies of service interactions. In the case of service interactions, the potential and realized degree are equivalent.
% }
% \label{fig:meandegree}
% \end{figure*}
% 

\begin{figure*}[h!]
\centering
\includegraphics[width=0.6\textwidth]{fig_redundancy.pdf}
\caption{
\textbf{a}, Number of redundant modifiers in the source pool as a function of the expected number of modifiers made per species $\eta$.
The red dashed line shows the analytical expectation (Eq. \ref{eq:redundant}).
\textbf{b}, Proportion of redundant modifiers $\phi$ versus the total number of modifiers in the source pool as a function of the expected number of modifiers made per species $\eta$.
The red dashed line shows the analytical expectation of $\phi \approx 0.418$ (Eq. \ref{eq:redundantprop}).
}
\label{fig:redundancy}
\end{figure*}

\begin{figure*}[h!]
\centering
\includegraphics[width=0.6\textwidth]{fig_engineers5_unique.pdf}
\caption{
Measures of community stability as a function of the frequency of service interactions and number of modifiers per species, where each modifier is uniquely made by an engineer.
\textbf{a}, Mean rates of primary extinction, where primary extinctions occur from competitive exclusion of consumers over shared resources.
\textbf{b}, Mean rates of secondary extinction, which cascade from primary extinctions.
\textbf{c}, Mean species persistence, defined as the percent simulation time the community is occupied by a given species, averaged across all species that successfully colonize.
\textbf{d}, The ratio $S^*_{\rm u}/S^*$, where $S^*_{\rm u}$ denotes steady states for systems where all engineered modifiers are unique to each engineer, and $S^*$ denote steady states for systems with redundant engineering. Lower values of $S^*_{\rm u}/S^*$ mean that systems with redundant engineers have higher steady states than those without redundancies.
Values are averaged over 50 replicates for each parameterization.
See Methods for default parameter values.
}
\label{fig:unique}
\end{figure*}

\begin{figure*}[h!]
\centering
\includegraphics[width=0.8\textwidth]{fig_steadystates2.pdf}
\caption{
\textbf{a}, Steady state community richness with redundant engineering.
\textbf{b}, Steady state community richness without redundant engineering.
\textbf{c}, Proportion of species in the source pool that colonize the community at least once throughout the simulation (with redundant engineering).
\textbf{d}, Proportion of species in the source pool that colonize the community at least once throughout the simulation (without redundant engineering).
}
\label{fig:steadystate}
\end{figure*}


\end{document}
